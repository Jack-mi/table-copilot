<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoGen WebSocket å®¢æˆ·ç«¯</title>
    <!-- Markdown æ¸²æŸ“åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <!-- ä»£ç é«˜äº®åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- åˆå§‹åŒ– marked é…ç½®ï¼ˆåœ¨åº“åŠ è½½åæ‰§è¡Œï¼‰ -->
    <script>
        // ç­‰å¾…åº“åŠ è½½å®Œæˆ
        window.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ marked æ˜¯å¦åŠ è½½
            if (typeof marked !== 'undefined') {
                marked.setOptions({
                    breaks: true,  // å°†å•ä¸ªæ¢è¡Œç¬¦è½¬æ¢ä¸º <br>
                    gfm: true,     // å¯ç”¨ GitHub Flavored Markdown
                    headerIds: false,
                    mangle: false
                });
                // marked.js å·²åŠ è½½å¹¶é…ç½®
            } else {
                console.error('âŒ marked.js æœªåŠ è½½ï¼ŒMarkdown æ¸²æŸ“å°†ä¸å¯ç”¨');
            }
            
            // æ£€æŸ¥ highlight.js æ˜¯å¦åŠ è½½
            if (typeof hljs === 'undefined') {
                console.warn('âš ï¸ highlight.js æœªåŠ è½½ï¼Œä»£ç å—å°†ä¸ä¼šé«˜äº®');
            }
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff4444;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #44ff44;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.assistant {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.5;
        }

        /* Markdown æ ·å¼ */
        .message-content.markdown {
            padding: 16px 20px;
        }

        .message-content.markdown h1,
        .message-content.markdown h2,
        .message-content.markdown h3,
        .message-content.markdown h4 {
            margin-top: 16px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .message-content.markdown h1 {
            font-size: 1.5em;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 8px;
        }

        .message-content.markdown h2 {
            font-size: 1.3em;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 6px;
        }

        .message-content.markdown h3 {
            font-size: 1.1em;
        }

        .message-content.markdown p {
            margin: 8px 0;
        }

        .message-content.markdown ul,
        .message-content.markdown ol {
            margin: 8px 0;
            padding-left: 24px;
        }

        .message-content.markdown li {
            margin: 4px 0;
        }

        .message-content.markdown code {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message-content.markdown pre {
            background-color: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            overflow-x: auto;
            margin: 12px 0;
        }

        .message-content.markdown pre code {
            background-color: transparent;
            padding: 0;
            border-radius: 0;
            font-size: 0.85em;
            line-height: 1.5;
        }

        .message-content.markdown blockquote {
            border-left: 4px solid #667eea;
            padding-left: 16px;
            margin: 12px 0;
            color: #666;
            font-style: italic;
        }

        .message-content.markdown table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
        }

        .message-content.markdown table th,
        .message-content.markdown table td {
            border: 1px solid #e0e0e0;
            padding: 8px 12px;
            text-align: left;
        }

        .message-content.markdown table th {
            background-color: #f5f5f5;
            font-weight: 600;
        }

        .message-content.markdown hr {
            border: none;
            border-top: 1px solid #e0e0e0;
            margin: 16px 0;
        }

        .message-content.markdown strong {
            font-weight: 600;
        }

        .message-content.markdown em {
            font-style: italic;
        }

        .message-content.markdown a {
            color: #667eea;
            text-decoration: none;
        }

        .message-content.markdown a:hover {
            text-decoration: underline;
        }

        /* ç”¨æˆ·æ¶ˆæ¯ä¸­çš„ markdownï¼ˆç™½è‰²èƒŒæ™¯ï¼‰ */
        .message.user .message-content.markdown code {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .message.user .message-content.markdown pre {
            background-color: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
        }

        .message.system .message-content {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            text-align: center;
            max-width: 100%;
            font-size: 12px;
        }

        /* æ€è€ƒè¿‡ç¨‹æ ·å¼ */
        .thought-section {
            background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
            border: 1px solid #c4b5fd;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .thought-section .section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #7c3aed;
            font-weight: 600;
            margin-bottom: 8px;
            cursor: pointer;
            user-select: none;
        }

        .thought-section .section-header:hover {
            color: #6d28d9;
        }

        .thought-section .section-header .toggle-icon {
            transition: transform 0.2s;
        }

        .thought-section .section-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .thought-section .thought-content {
            color: #5b21b6;
            line-height: 1.6;
            white-space: pre-wrap;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .thought-section .thought-content.collapsed {
            max-height: 0;
            padding: 0;
        }

        /* å·¥å…·è°ƒç”¨æ ·å¼ */
        .tool-calls-section {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 1px solid #86efac;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .tool-calls-section .section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #16a34a;
            font-weight: 600;
            margin-bottom: 8px;
            cursor: pointer;
            user-select: none;
        }

        .tool-calls-section .section-header:hover {
            color: #15803d;
        }

        .tool-calls-section .section-header .toggle-icon {
            transition: transform 0.2s;
        }

        .tool-calls-section .section-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .tool-calls-section .tool-calls-content {
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .tool-calls-section .tool-calls-content.collapsed {
            max-height: 0;
            padding: 0;
        }

        .tool-call-item {
            background: white;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 8px;
        }

        .tool-call-item:last-child {
            margin-bottom: 0;
        }

        .tool-call-item .tool-name {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            color: #166534;
            margin-bottom: 6px;
        }

        .tool-call-item .tool-name .status-icon {
            font-size: 14px;
        }

        .tool-call-item .tool-name .status-icon.completed {
            color: #22c55e;
        }

        .tool-call-item .tool-name .status-icon.error {
            color: #ef4444;
        }

        .tool-call-item .tool-name .status-icon.pending {
            color: #f59e0b;
        }

        .tool-call-item .tool-args {
            background: #f0fdf4;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #166534;
            margin-bottom: 6px;
            overflow-x: auto;
        }

        .tool-call-item .tool-result {
            background: #ecfdf5;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #065f46;
            white-space: pre-wrap;
            max-height: 150px;
            overflow-y: auto;
        }

        .tool-call-item .tool-result.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        /* å“åº”å†…å®¹åŒºåŸŸ */
        .response-content-section {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e5e7eb;
        }

        /* å¢å¼ºæ¶ˆæ¯å†…å®¹å®½åº¦ä»¥é€‚åº”æ›´å¤šå†…å®¹ */
        .message.assistant .message-content {
            max-width: 85%;
        }

        /* åŒºåŸŸå†…æ»šåŠ¨æ¡æ ·å¼ */
        .tool-result::-webkit-scrollbar,
        .thought-content::-webkit-scrollbar {
            width: 6px;
        }

        .tool-result::-webkit-scrollbar-track,
        .thought-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .tool-result::-webkit-scrollbar-thumb {
            background: #86efac;
            border-radius: 3px;
        }

        .thought-content::-webkit-scrollbar-thumb {
            background: #c4b5fd;
            border-radius: 3px;
        }

        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        /* è¾“å…¥æ¡†æ”¹ä¸ºå¤šè¡Œ textareaï¼Œæ”¯æŒæ»šåŠ¨ */
        .input-area textarea {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.5;
            outline: none;
            transition: border-color 0.3s;
            min-height: 60px;      /* é»˜è®¤é«˜åº¦æ›´å¤§ä¸€äº› */
            max-height: 160px;     /* ä¸Šé™ï¼Œè¶…è¿‡åå†…éƒ¨æ»šåŠ¨ */
            resize: vertical;      /* å…è®¸ç”¨æˆ·æ‰‹åŠ¨æ‹–æ‹½é«˜åº¦ */
            overflow-y: auto;
        }

        .input-area textarea:focus {
            border-color: #667eea;
        }

        .input-area button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .input-area button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .input-area button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .clear-btn {
            padding: 8px 16px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }

        .clear-btn:hover {
            background: #ff5252;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AutoGen å¯¹è¯åŠ©æ‰‹</h1>
            <div class="status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">æœªè¿æ¥</span>
            </div>
        </div>
        
        <div class="messages" id="messages">
            <div class="message system">
                <div class="message-content">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</div>
            </div>
        </div>
        
        <div class="input-area">
            <textarea
                id="messageInput"
                placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒEnter å‘é€ï¼ŒShift+Enter æ¢è¡Œ..."
                disabled
                onkeypress="handleKeyPress(event)"
            ></textarea>
            <button id="sendBtn" onclick="sendMessage()" disabled>
                <span id="sendBtnText">å‘é€</span>
            </button>
            <button class="clear-btn" onclick="clearHistory()">æ¸…ç©º</button>
            <button class="clear-btn" onclick="manualReconnect()" style="background: #4CAF50;">é‡è¿</button>
        </div>
    </div>

    <script>
        let ws = null;
        let sessionId = 'client_' + Date.now();
        let isProcessing = false;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let reconnectDelay = 3000;
        let isManualClose = false;
        let reconnectTimer = null;
        
        // æ—¥å¿—å‡½æ•° - ä¿ç•™åŸºç¡€è°ƒè¯•ä¿¡æ¯
        function log(level, message, data = null) {
            if (level === 'ERROR') {
                console.error(`[${level}] ${message}`, data || '');
                const displayMsg = data ? `${message} (${JSON.stringify(data).substring(0, 100)})` : message;
                addSystemMessage(`âš ï¸ ${displayMsg}`);
            } else if (level === 'WARN') {
                console.warn(`[${level}] ${message}`, data || '');
                addSystemMessage(`âš ï¸ ${message}`);
            } else if (level === 'INFO') {
                console.log(`[${level}] ${message}`, data || '');
            } else if (level === 'DEBUG') {
                // å¦‚éœ€æ›´å®‰é™ï¼Œå¯ä»¥æŠŠè¿™è¡Œæ³¨é‡Šæ‰
                console.debug(`[${level}] ${message}`, data || '');
            }
        }

        function updateStatus(connected) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');

            if (connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'å·²è¿æ¥';
                messageInput.disabled = false;
                sendBtn.disabled = false;
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'æœªè¿æ¥';
                messageInput.disabled = true;
                sendBtn.disabled = true;
            }
        }

        function addMessage(content, type = 'assistant', thoughts = [], toolCalls = []) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // å¯¹äº assistant ç±»å‹çš„æ¶ˆæ¯ï¼Œä½¿ç”¨ markdown æ¸²æŸ“
            // å¯¹äº system å’Œ user ç±»å‹ï¼Œä¿æŒçº¯æ–‡æœ¬ï¼ˆä½† user ä¹Ÿå¯ä»¥æ”¯æŒ markdownï¼‰
            if (type === 'assistant' || type === 'user') {
                contentDiv.classList.add('markdown');
                
                let htmlContent = '';
                
                // å¦‚æœæ˜¯ assistant æ¶ˆæ¯ï¼Œæ·»åŠ æ€è€ƒè¿‡ç¨‹å’Œå·¥å…·è°ƒç”¨
                if (type === 'assistant') {
                    // æ·»åŠ æ€è€ƒè¿‡ç¨‹ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (thoughts && thoughts.length > 0) {
                        htmlContent += createThoughtSection(thoughts);
                    }
                    
                    // æ·»åŠ å·¥å…·è°ƒç”¨ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (toolCalls && toolCalls.length > 0) {
                        htmlContent += createToolCallsSection(toolCalls);
                    }
                }
                
                // æ·»åŠ ä¸»è¦å“åº”å†…å®¹
                try {
                    // ä½¿ç”¨ marked æ¸²æŸ“ markdown
                    if (typeof marked !== 'undefined') {
                        // é…ç½® marked é€‰é¡¹ï¼šå°†å•ä¸ªæ¢è¡Œç¬¦è½¬æ¢ä¸º <br>
                        marked.setOptions({
                            breaks: true,  // å°†å•ä¸ªæ¢è¡Œç¬¦è½¬æ¢ä¸º <br>ï¼Œè¿™æ · \n å°±ä¼šæ˜¾ç¤ºä¸ºæ¢è¡Œ
                            gfm: true,     // å¯ç”¨ GitHub Flavored Markdownï¼ˆæ”¯æŒä»»åŠ¡åˆ—è¡¨ã€è¡¨æ ¼ç­‰ï¼‰
                            headerIds: false,
                            mangle: false
                        });
                        
                        // é¢„å¤„ç†ï¼šç¡®ä¿æ¢è¡Œç¬¦æ˜¯çœŸæ­£çš„æ¢è¡Œç¬¦ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸² "\n"
                        // å¦‚æœå†…å®¹ä¸­åŒ…å«å­—é¢é‡ "\n"ï¼ˆä¸¤ä¸ªå­—ç¬¦ï¼‰ï¼Œå…ˆè½¬æ¢ä¸ºçœŸæ­£çš„æ¢è¡Œç¬¦
                        let processedContent = content;
                        // å¤„ç†è½¬ä¹‰çš„æ¢è¡Œç¬¦ï¼ˆå¦‚æœ JSON è§£æåè¿˜æ˜¯å­—ç¬¦ä¸² "\n"ï¼‰
                        processedContent = processedContent.replace(/\\n/g, '\n');
                        // å¤„ç†è½¬ä¹‰çš„å…¶ä»–å­—ç¬¦
                        processedContent = processedContent.replace(/\\t/g, '\t');
                        processedContent = processedContent.replace(/\\r/g, '\r');
                        
                        // ä½¿ç”¨ marked è§£æ
                        const mainContent = marked.parse(processedContent);
                        
                        if (htmlContent) {
                            // å¦‚æœæœ‰æ€è€ƒè¿‡ç¨‹æˆ–å·¥å…·è°ƒç”¨ï¼ŒæŠŠä¸»è¦å†…å®¹åŒ…è£…åœ¨ä¸€ä¸ªåŒºåŸŸé‡Œ
                            htmlContent += '<div class="response-content-section">' + mainContent + '</div>';
                        } else {
                            htmlContent = mainContent;
                        }
                        
                        contentDiv.innerHTML = htmlContent;
                        
                        // é«˜äº®ä»£ç å—
                        if (typeof hljs !== 'undefined') {
                            contentDiv.querySelectorAll('pre code').forEach((block) => {
                                hljs.highlightElement(block);
                            });
                        }
                    } else {
                        console.error('âŒ marked.js æœªåŠ è½½ï¼è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ– CDN æ˜¯å¦å¯è®¿é—®');
                        // å¦‚æœ marked æœªåŠ è½½ï¼Œå›é€€åˆ°çº¯æ–‡æœ¬ï¼Œä½†ä¿ç•™æ¢è¡Œ
                        // åŒæ ·å¤„ç†è½¬ä¹‰çš„æ¢è¡Œç¬¦
                        let fallbackContent = content.replace(/\\n/g, '\n');
                        htmlContent += fallbackContent.replace(/\n/g, '<br>');
                        contentDiv.innerHTML = htmlContent;
                    }
                } catch (e) {
                    console.error('Markdown æ¸²æŸ“å¤±è´¥:', e);
                    // å‡ºé”™æ—¶ä¹Ÿä¿ç•™æ¢è¡Œ
                    htmlContent += content.replace(/\n/g, '<br>');
                    contentDiv.innerHTML = htmlContent;
                }
            } else {
                // system æ¶ˆæ¯ä¿æŒçº¯æ–‡æœ¬ï¼Œä½†ä¿ç•™æ¢è¡Œ
                contentDiv.innerHTML = content.replace(/\n/g, '<br>');
            }
            
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // åˆ›å»ºæ€è€ƒè¿‡ç¨‹åŒºåŸŸ
        function createThoughtSection(thoughts) {
            const thoughtsText = thoughts.map(t => t.content || t).join('\n\n');
            const uniqueId = 'thought-' + Date.now();
            
            return `
                <div class="thought-section">
                    <div class="section-header" onclick="toggleSection('${uniqueId}')">
                        <span class="toggle-icon">â–¼</span>
                        <span>ğŸ§  æ€è€ƒè¿‡ç¨‹</span>
                    </div>
                    <div class="thought-content" id="${uniqueId}">
                        ${escapeHtml(thoughtsText)}
                    </div>
                </div>
            `;
        }
        
        // åˆ›å»ºå·¥å…·è°ƒç”¨åŒºåŸŸ
        function createToolCallsSection(toolCalls) {
            const uniqueId = 'tools-' + Date.now();
            
            let toolsHtml = toolCalls.map(tc => {
                const statusIcon = tc.status === 'completed' ? 'âœ…' : 
                                   tc.status === 'error' ? 'âŒ' : 'â³';
                const statusClass = tc.status || 'pending';
                
                // æ ¼å¼åŒ–å‚æ•°
                let argsDisplay = tc.arguments || '{}';
                try {
                    const argsObj = JSON.parse(argsDisplay);
                    argsDisplay = JSON.stringify(argsObj, null, 2);
                } catch (e) {
                    // ä¿æŒåŸæ ·
                }
                
                // æ ¼å¼åŒ–ç»“æœï¼šä¼˜å…ˆå±•ç¤º JSON ä¸­çš„ message/contentï¼Œè€Œä¸æ˜¯åŸå§‹ JSON
                let resultHtml = '';
                if (tc.result !== undefined) {
                    let displayResult = typeof tc.result === 'string' ? tc.result : String(tc.result);
                    try {
                        const parsed = JSON.parse(displayResult);
                        if (parsed && typeof parsed === 'object') {
                            if (typeof parsed.message === 'string' && parsed.message.trim()) {
                                displayResult = parsed.message;
                            } else if (typeof parsed.content === 'string' && parsed.content.trim()) {
                                displayResult = parsed.content;
                            }
                        }
                    } catch (_) { /* é JSONï¼Œä¿æŒåŸæ · */ }
                    const resultClass = tc.is_error ? 'error' : '';
                    resultHtml = `<div class="tool-result ${resultClass}">${escapeHtml(displayResult)}</div>`;
                }
                
                return `
                    <div class="tool-call-item">
                        <div class="tool-name">
                            <span class="status-icon ${statusClass}">${statusIcon}</span>
                            <span>${tc.name || 'Unknown Tool'}</span>
                        </div>
                        <div class="tool-args">${escapeHtml(argsDisplay)}</div>
                        ${resultHtml}
                    </div>
                `;
            }).join('');
            
            return `
                <div class="tool-calls-section">
                    <div class="section-header" onclick="toggleSection('${uniqueId}')">
                        <span class="toggle-icon">â–¼</span>
                        <span>ğŸ”§ å·¥å…·è°ƒç”¨ (${toolCalls.length})</span>
                    </div>
                    <div class="tool-calls-content" id="${uniqueId}">
                        ${toolsHtml}
                    </div>
                </div>
            `;
        }
        
        // åˆ‡æ¢å±•å¼€/æŠ˜å 
        function toggleSection(id) {
            const content = document.getElementById(id);
            const header = content.previousElementSibling;
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                header.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                header.classList.add('collapsed');
            }
        }
        
        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function addSystemMessage(content) {
            addMessage(content, 'system');
        }

        function connect() {
            // å¦‚æœå·²ç»æœ‰è¿æ¥ï¼Œå…ˆå…³é—­
            if (ws && ws.readyState !== WebSocket.CLOSED) {
                log('INFO', 'å…³é—­ç°æœ‰è¿æ¥');
                isManualClose = true;
                ws.close();
            }
            
            // æ¸…é™¤ä¹‹å‰çš„é‡è¿å®šæ—¶å™¨
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
                reconnectTimer = null;
            }
            
            // æ£€æŸ¥é‡è¿æ¬¡æ•°
            if (reconnectAttempts >= maxReconnectAttempts) {
                log('ERROR', `å·²è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•° (${maxReconnectAttempts})ï¼Œåœæ­¢é‡è¿`);
                addSystemMessage(`âŒ è¿æ¥å¤±è´¥ï¼Œå·²å°è¯• ${maxReconnectAttempts} æ¬¡ã€‚è¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œã€‚`);
                updateStatus(false);
                return;
            }
            
            const wsUrl = 'ws://localhost:8765';
            log('INFO', 'å¼€å§‹è¿æ¥ WebSocket', { url: wsUrl });
            
            try {
                ws = new WebSocket(wsUrl);
                
                // è®¾ç½®è¿æ¥è¶…æ—¶
                let connectTimeout = null;
                connectTimeout = setTimeout(() => {
                    if (ws && ws.readyState === WebSocket.CONNECTING) {
                        log('ERROR', 'è¿æ¥è¶…æ—¶ (5ç§’)', { readyState: ws.readyState });
                        ws.close();
                        reconnectAttempts++;
                        if (reconnectAttempts < maxReconnectAttempts) {
                            log('INFO', 'è¶…æ—¶åè§¦å‘é‡è¿');
                            reconnectTimer = setTimeout(() => {
                                if (!isManualClose) {
                                    connect();
                                }
                            }, reconnectDelay * reconnectAttempts);
                        }
                    }
                }, 5000); // 5ç§’è¶…æ—¶

                ws.onopen = () => {
                    if (connectTimeout) {
                        clearTimeout(connectTimeout);
                        connectTimeout = null;
                    }
                    reconnectAttempts = 0; // é‡ç½®é‡è¿è®¡æ•°
                    updateStatus(true);
                    addSystemMessage('âœ… å·²è¿æ¥åˆ°æœåŠ¡å™¨');
                    isManualClose = false;
                    log('INFO', 'WebSocket è¿æ¥å·²æ‰“å¼€');
                };

                ws.onmessage = (event) => {
                    log('DEBUG', 'æ”¶åˆ°åŸå§‹æ¶ˆæ¯', { raw: event.data });
                    try {
                        const data = JSON.parse(event.data);
                        log('INFO', 'æ”¶åˆ°æ¶ˆæ¯', { type: data.type });

                        switch (data.type) {
                            case 'connection':
                                addSystemMessage('âœ… ' + data.message);
                                break;
                            case 'status':
                                if (data.status === 'processing') {
                                    isProcessing = true;
                                    updateSendButton(true);
                                }
                                break;
                            case 'response':
                                isProcessing = false;
                                updateSendButton(false);
                                // æ‰“å°å®Œæ•´çš„æ¨¡å‹ response åˆ° console
                                console.log('[Model Response] å®Œæ•´å“åº”:', data);
                                // ä¼ é€’æ€è€ƒè¿‡ç¨‹å’Œå·¥å…·è°ƒç”¨
                                addMessage(
                                    data.content,
                                    'assistant',
                                    data.thoughts || [],
                                    data.tool_calls || []
                                );
                                break;
                            case 'error':
                                log('ERROR', 'æœåŠ¡å™¨é”™è¯¯', { message: data.message });
                                isProcessing = false;
                                updateSendButton(false);
                                addSystemMessage('âŒ é”™è¯¯: ' + data.message);
                                break;
                            case 'pong':
                                // å¿ƒè·³å“åº”
                                break;
                            default:
                                log('WARN', 'æœªçŸ¥æ¶ˆæ¯ç±»å‹', { type: data.type, payload: data });
                        }
                    } catch (e) {
                        log('ERROR', 'è§£ææ¶ˆæ¯å¤±è´¥', { error: e.message, raw: event.data });
                        addSystemMessage('âŒ æ¶ˆæ¯è§£æå¤±è´¥: ' + e.message);
                    }
                };


                ws.onclose = (event) => {
                    log('WARN', 'WebSocket è¿æ¥å…³é—­', { code: event.code, reason: event.reason });
                    if (connectTimeout) {
                        clearTimeout(connectTimeout);
                        connectTimeout = null;
                    }
                    updateStatus(false);
                    
                    // å¦‚æœæ˜¯æ‰‹åŠ¨å…³é—­ï¼Œä¸é‡è¿
                    if (isManualClose) {
                        return;
                    }
                    
                    // æ ¹æ®å…³é—­ä»£ç åˆ¤æ–­æ˜¯å¦éœ€è¦é‡è¿
                    if (event.code === 1000) {
                        // æ­£å¸¸å…³é—­
                        return;
                    }
                    
                    // å¢åŠ é‡è¿æ¬¡æ•°
                    reconnectAttempts++;
                    
                    if (reconnectAttempts < maxReconnectAttempts) {
                        addSystemMessage(`âš ï¸ è¿æ¥å·²æ–­å¼€ï¼Œæ­£åœ¨é‡è¿... (${reconnectAttempts}/${maxReconnectAttempts})`);
                        
                        // å»¶è¿Ÿé‡è¿ï¼Œå»¶è¿Ÿæ—¶é—´é€æ¸å¢åŠ 
                        const delay = reconnectDelay * reconnectAttempts;
                        reconnectTimer = setTimeout(() => {
                            if (!isManualClose) {
                                connect();
                            }
                        }, delay);
                    } else {
                        addSystemMessage(`âŒ è¿æ¥å¤±è´¥ï¼Œå·²å°è¯• ${maxReconnectAttempts} æ¬¡ã€‚è¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œåœ¨ ws://localhost:8765`);
                        log('ERROR', 'è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œåœæ­¢é‡è¿');
                    }
                };
                
                ws.onerror = (error) => {
                    if (connectTimeout) {
                        clearTimeout(connectTimeout);
                        connectTimeout = null;
                    }
                    log('ERROR', 'WebSocket è¿æ¥é”™è¯¯', error);
                };
            } catch (e) {
                log('ERROR', 'åˆ›å»º WebSocket å¤±è´¥', { error: e.message });
                reconnectAttempts++;
                if (reconnectAttempts < maxReconnectAttempts) {
                    addSystemMessage(`âŒ è¿æ¥å¤±è´¥: ${e.message}ï¼Œå°†åœ¨ ${reconnectDelay * reconnectAttempts}ms åé‡è¯•`);
                    reconnectTimer = setTimeout(() => {
                        if (!isManualClose) {
                            connect();
                        }
                    }, reconnectDelay * reconnectAttempts);
                } else {
                    addSystemMessage(`âŒ è¿æ¥å¤±è´¥ï¼Œå·²å°è¯• ${maxReconnectAttempts} æ¬¡`);
                }
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) {
                return;
            }
            
            if (isProcessing) {
                return;
            }
            
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('ERROR', 'WebSocket æœªè¿æ¥');
                addSystemMessage('âŒ æœªè¿æ¥åˆ°æœåŠ¡å™¨');
                return;
            }
            
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage(message, 'user');
            input.value = '';

            // å‘é€åˆ°æœåŠ¡å™¨
            const data = {
                type: 'message',
                content: message,
                session_id: sessionId
            };

            try {
                log('INFO', 'å‘é€æ¶ˆæ¯', data);
                ws.send(JSON.stringify(data));
            } catch (e) {
                log('ERROR', 'å‘é€æ¶ˆæ¯å¤±è´¥', { error: e.message });
                addSystemMessage('âŒ å‘é€å¤±è´¥: ' + e.message);
            }
        }

        function clearHistory() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                return;
            }

            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';
            addSystemMessage('ğŸ—‘ï¸ å†å²è®°å½•å·²æ¸…ç©º');

            // å‘é€æ¸…é™¤å†å²è¯·æ±‚
            const payload = {
                type: 'clear_history',
                session_id: sessionId
            };
            log('INFO', 'å‘é€æ¸…ç©ºå†å²è¯·æ±‚', payload);
            ws.send(JSON.stringify(payload));

            // ç”Ÿæˆæ–°çš„ session ID
            sessionId = 'client_' + Date.now();
        }

        function updateSendButton(processing) {
            const sendBtn = document.getElementById('sendBtn');
            const sendBtnText = document.getElementById('sendBtnText');
            
            if (processing) {
                sendBtn.disabled = true;
                sendBtnText.innerHTML = '<span class="loading"></span>';
            } else {
                sendBtn.disabled = false;
                sendBtnText.textContent = 'å‘é€';
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // é¡µé¢åŠ è½½æ—¶è¿æ¥
        window.addEventListener('load', () => {
            connect();
        });

        // é¡µé¢å…³é—­æ—¶æ–­å¼€è¿æ¥
        window.addEventListener('beforeunload', () => {
            isManualClose = true;
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
            }
            if (ws) {
                ws.close();
            }
        });
        
        // æ·»åŠ æ‰‹åŠ¨é‡è¿æŒ‰é’®åŠŸèƒ½
        function manualReconnect() {
            reconnectAttempts = 0; // é‡ç½®è®¡æ•°
            isManualClose = false;
            connect();
        }
        
        // æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ
        async function checkServer() {
            try {
                // å°è¯•é€šè¿‡ HTTP æ£€æŸ¥æœåŠ¡å™¨ï¼ˆå¦‚æœæœåŠ¡å™¨æœ‰å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼‰
                // è¿™é‡Œæˆ‘ä»¬ç›´æ¥å°è¯•è¿æ¥ WebSocket
                return true;
            } catch (e) {
                return false;
            }
        }
    </script>
</body>
</html>
